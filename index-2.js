const express = require('express');
const session = require('express-session');
const Keycloak = require('keycloak-connect');
const FileStore = require('session-file-store')(session);

// Ð§Ñ‚Ð¾ Ð¿Ñ€Ð¾Ð¸ÑÑ…Ð¾Ð´Ð¸Ñ‚:
// â€¢ express â€” Ñ„Ñ€ÐµÐ¹Ð¼Ð²Ð¾Ñ€Ðº Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÑÐµÑ€Ð²ÐµÑ€Ð°.
// â€¢ express-session â€” Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ ÑÐµÑÑÐ¸Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ñ‡Ñ‚Ð¾ Ð¾Ð½ Ð²Ð¾ÑˆÑ‘Ð» Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ).
// â€¢ keycloak-connect â€” Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ° Ð´Ð»Ñ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Keycloak Ðº Express.
// â€¢ session-file-store â€” Ð¼Ð¾Ð´ÑƒÐ»ÑŒ, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÑ‚ ÑÐµÑÑÐ¸Ð¸ Ð² Ñ„Ð°Ð¹Ð»Ñ‹ (Ð¼Ð¾Ð¶Ð½Ð¾ Ð·Ð°Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð½Ð° Redis Ð¸Ð»Ð¸ Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ð° Ð² Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐµÐ½Ðµ).

// Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ ÑÐºÐ·ÐµÐ¼Ð¿Ð»ÑÑ€ Express-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ.
const app = express();

// ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÑÐµÑÑÐ¸Ð¹:
// â€¢ secret â€” ÐºÐ»ÑŽÑ‡, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¼ ÑˆÐ¸Ñ„Ñ€ÑƒÐµÑ‚ÑÑ ÑÐµÑÑÐ¸Ð¾Ð½Ð½Ñ‹Ð¹ ID (Ð½ÑƒÐ¶ÐµÐ½ Ð´Ð»Ñ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸).
// â€¢ resave: false â€” Ð½Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÑ‚ÑŒ ÑÐµÑÑÐ¸ÑŽ, ÐµÑÐ»Ð¸ Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»Ð¾ÑÑŒ.
// â€¢ saveUninitialized: true â€” ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÑ‚ÑŒ Ð½Ð¾Ð²ÑƒÑŽ ÑÐµÑÑÐ¸ÑŽ, Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ Ð¾Ð½Ð° Ð¿ÑƒÑÑ‚Ð°Ñ.
// â€¢ store â€” Ð¼ÐµÑÑ‚Ð¾, ÐºÑƒÐ´Ð° ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÑŽÑ‚ÑÑ ÑÐµÑÑÐ¸Ð¸ (Ð² Ð´Ð°Ð½Ð½Ð¾Ð¼ ÑÐ»ÑƒÑ‡Ð°Ðµ Ñ„Ð°Ð¹Ð»Ñ‹).
const memoryStore = new FileStore();
app.use(session({
    secret: 'super-secret-key',
    resave: false,
    saveUninitialized: true,
    store: memoryStore
}));

// Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ ÑÐºÐ·ÐµÐ¼Ð¿Ð»ÑÑ€ Keycloak Ð¸ Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‘Ð¼ Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ ÑÐµÑÑÐ¸Ð¹.
const keycloak = new Keycloak({ store: memoryStore });

// ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ middleware:
// â€¢ logout â€” Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚, Ð¿Ð¾ ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ð¼Ñƒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð²Ñ‹Ð¹Ð´ÐµÑ‚ Ð¸Ð· ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹.
// â€¢ admin â€” Ð¿ÑƒÑ‚ÑŒ, Ð³Ð´Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ Ð°Ð´Ð¼Ð¸Ð½-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ Keycloak (Ð½Ðµ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÐµÐ½, Ð¼Ð¾Ð¶Ð½Ð¾ Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ).
app.use(keycloak.middleware({
    logout: '/logout',
    admin: '/'
}));

// ÐžÑ‚ÐºÑ€Ñ‹Ñ‚Ñ‹Ð¹ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚ â€” Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð²ÑÐµÐ¼, Ð´Ð°Ð¶Ðµ Ð½ÐµÐ°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼.
app.get('/', (req, res) => {
    res.send('Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ! <a href="/secure">ÐŸÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ð² Ð·Ð°Ñ‰Ð¸Ñ‰Ñ‘Ð½Ð½ÑƒÑŽ Ð·Ð¾Ð½Ñƒ</a>');
});

// Ð—Ð°Ñ‰Ð¸Ñ‰Ñ‘Ð½Ð½Ñ‹Ð¹ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚:
// â€¢ keycloak.protect() â€” middleware, ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚: Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½ Ð»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ.
// â€¢ Ð•ÑÐ»Ð¸ Ð½ÐµÑ‚ â€” Ð¿ÐµÑ€ÐµÐ½Ð°Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ Ð»Ð¾Ð³Ð¸Ð½Ð° Keycloak.
// â€¢ Ð•ÑÐ»Ð¸ Ð´Ð° â€” Ð¾Ñ‚Ð´Ð°Ñ‘Ñ‚ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹.
app.get('/secure', keycloak.protect(), (req, res) => {
    res.send('Ð’Ñ‹ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½Ñ‹! ðŸŽ‰ <a href="/logout">Ð’Ñ‹Ð¹Ñ‚Ð¸</a>');
});

// Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð° Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ 3000.
app.listen(3000, () => {
    console.log('Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° http://localhost:3000');
});


